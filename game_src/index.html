<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="css/bootstrap.min.css">
        <style>
            body {
                padding-top: 45px;
                padding-bottom: 20px;
            }
            .col-md-12 {
                border: 2px solid black;
                border-radius: 10px 10px 10px 10px;
                margin: 5px;
            }
            .center {
                text-align: center;
            }
            .campo {
              margin-bottom: 25px;
              background-color: white;
              padding: 1px;
              height: 510px;
            }
            .campo img {position: relative; float: left }
            .table-no-border>thead>tr>th, 
            .table-no-border>tbody>tr>th, 
            .table-no-border>tfoot>tr>th, 
            .table-no-border>thead>tr>td, 
            .table-no-border>tbody>tr>td, 
            .table-no-border>tfoot>tr>td {

              border-top: none;
              border-spacing: 0px; 
              border-collapse: collapse;
            }
            .marginpadding {
              margin: 0;
              padding: 0;
            }
        </style>
        <link rel="stylesheet" href="css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="css/main.css">

        <script src="js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="index.html">Alla scoperta dell'informatica</a>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- Example row of columns -->
      <div class="row"><h1 class="center"> <img id="Pres_gioco" src="http://icons.iconarchive.com/icons/dapino/callcenter-girls/64/callcenter-girls-glasses-icon.png" style="margin: 0; padding: 0;"> Alla scoperta dell'informatica</h1></div>
      <div class="row" id="campo_totale">
        <div class="col-md-12 marginpadding" id="contenitore_campo_console">
          <div class="col-md-9">
            <h2 class="center">Campo di gioco</h2>
            <div class="campo">
            </div>
          </div>
          <div class="col-md-3">  
            <h2 class="center">Console</h2>
            <p>Inserisci comando</p>
            <p class="center"><input type="text" class="form-control" id="comando"> <br /> <a class="btn btn-default" href="#" role="button" onclick="esegui_comando()">Esegui</a> <a class="btn btn-default" href="#" role="button">Cancella</a></p>
            <p><h2 class="center">Log eventi</h2><div id="log_eventi" style="height: 310px; overflow: scroll;"><p>campo spiegazione errori</p></div></p>
          </div>
        </div>
      </div>

      <hr>

      <footer>
        <p>&copy; Caroti Rubens e Daniel Vedovato 2014</p>
      </footer>
    </div> <!-- /container -->        <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
        <script>window.jQuery || document.write('<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"><\/script>')</script>

        <script src="js/vendor/bootstrap.min.js"></script>

        <script src="js/main.js"></script>

        <script>
			/*Variabili*/{
				/*Debug*/{
					//Tutti i Debug:
					var var_debug_all = false;
					
					//Specifica funzione:
					var var_debug_pos_sprite_array = false;
					var var_debug_spost_personaggio = false;
					var var_debug_carica_sprite = false;
					var var_debug_pos_utilizzata = false;
					var var_debug_ostacoli_tragitto = false;
					var var_debug_ragg_sprite = false;
					var var_debug_obb_raggiunto = false;
					var var_debug_liv_successivo = false;
					var var_debug_carica_livello = false;
					var var_debug_spost_comando_non_valido = false;
					var var_debug_recupera_comando = false;
					
					//utility debug:
					var avvio_rapido = false;
					var var_obb_superflui = false;
					
					//Utility comando:
					var rimuovi_spazi_comando = true;
					var comand_case_sensitive = false;
					
					//forzature visualizzazione
					var var_vis_elm_celle = false; //contenuto cella
					var var_vis_griglia = false;   //griglia
				}
				
				/*Obbiettivi*/{
					var num_obbiettivi = 0;
				}
				  
				/*Livelli*/{
					//Livello e mappa corrente:
					var livello = 1;
					var mappa = 1;
					
					//numero livelli e mappe abbinate
					var liv_map = [
									{liv: 1, mp: 2}, //vuoto
									{liv: 2, mp: 2}, //+ obbiettivi
									{liv: 3, mp: 5}  //+ ostacoli
								  ];
					
					//Elementi livelli
					var liv_min_obbiettivi = 2;
					var liv_min_ostacoli = 3;
				}
				 
				/*posizioni*/{
					//array posizioni
						var posizioni = 
							[
								// {coordinate:"", oggetto:"Personaggio", number:0, completato:false, riga:0, colonna:0}, //personaggio
								// {coordinate:"", oggetto:"Exit",        number:0, completato:false, riga:0, colonna:0}, //exit
								// {coordinate:"", oggetto:'Ostacolo',    number:0, completato:false, riga:0, colonna:0}  //ostacolo
								// {coordinate:"", oggetto:'Obbiettivo',  number:0, completato:false, riga:0, colonna:0}  //obbiettivo
								
								// {coordinate:"", oggetto:'Percorso',    number:0, completato:false, riga:0, colonna:0}  //Percorso
							];
					}
				
				/*campo*/{
					var codice_campo_console = $('#campo_totale').html();
					  
					/*sfondo*/{
						var background_color_campo = '#ffcc00';
						var colore_griglia_se_visualizzata = '#FFDEAD';
						var colore_testo_campo = var_vis_elm_celle ? 'black' : background_color_campo;
					}
					 
					var sep_rig_col = "_"; //attenzione a caratteri accettati per id
					  
					//marcatore celle vuote
						var rg_pos_vuota = ".......";
						var pos_vuota =   rg_pos_vuota
										+ "<p>"
										+ rg_pos_vuota
									  ;
									  
					//marcatore celle attraversate
						var pos_attraversata =   "<i style='color: " + colore_testo_campo + ";'>......</i>"
											   + "<p>"
											   + "<i style='color: " + colore_testo_campo + ";'>...</i>*<i style='color: " + colore_testo_campo + ";'>...</i>"
											 ;
					
					//dimensioni:
						var num_righe = 15; //ex16;
						var num_colonne = 25; //ex14;
					
				}
				  
				/*sprite*/{
					//opzioni:
					var vuota_attrav_img = true;//cella vuota e percorso sono immagini
				
					/*personaggio:*/{
						var personaggio_img = 
							//'<img id="personaggio_01" src="http://icons.iconarchive.com/icons/itzikgur/my-seven/32/Girls-Blue-Dress-icon.png" style="margin: 0; padding: 0;">';
							//'<img id="personaggio_02" src="http://icons.iconarchive.com/icons/raindropmemory/harmonia-pastelis/32/hp-girl-icon.png" style="margin: 0; padding: 0;">';
							'<img id="personaggio_00" src="./sprite/personaggio.png" style="margin: 0; padding: 0;">';
					}
					
					/*uscita:*/{
						var exit_img = 
							//'<img id="exit_01" src="http://icons.iconarchive.com/icons/iconsmind/outline/32/Door-icon.png" style="margin: 0; padding: 0;">';
							//'<img id="exit_02" src="http://icons.iconarchive.com/icons/custom-icon-design/pretty-office-6/32/logout-icon.png" style="margin: 0; padding: 0;">';
							'<img id="exit_00" src="./sprite/exit.png" style="margin: 0; padding: 0;">';
					}
					
					/*Ostacolo:*/{
						var ostacolo_img =
							//'<img id="ostacolo_01" src="http://icons.iconarchive.com/icons/hybridworks/yoritsuki/32/Shoji2-paper-sliding-door-icon.png" style="margin: 0; padding: 0;">';
							//'<img id="ostacolo_02" src="http://icons.iconarchive.com/icons/hybridworks/yoritsuki/32/Shoji1-paper-sliding-door-icon.png" style="margin: 0; padding: 0;">';
							'<img id="ostacolo_00" src="./sprite/wall.png" style="margin: 0; padding: 0;">';
					}
					
					/*Obbiettivo:*/{
						var obbiettivo_img =
							//'<img id="obbiettivo_01" src="http://icons.iconarchive.com/icons/iconka/st-patricks-day/32/shamrock-lucky-icon.png" style="margin: 0; padding: 0;">';
							'<img id="obbiettivo_00" src="./sprite/quadrifoglio.png" style="margin: 0; padding: 0;">';
					}
					
					/*Vuota:*/{
						var pos_vuota_img =
						    '<img id="pos_vuota_00" src="./sprite/vuota.png" style="margin: 0; padding: 0;">';
					}
					
					/*Percorso:*/{
						var pos_attraversata_img =
						    '<img id="pos_attraversata_00" src="./sprite/attraversata.png" style="margin: 0; padding: 0;">';
					}
				}
				  
				/*Log:*/{
					//orario avvio:
					data_avvio_gioco = new Date();
					  
					//Log:
					var var_log = ((data_avvio_gioco.toTimeString()).split(' ')[0]) + " : <b style='color: green;'> Start</b><br />";
				}
			}  
			  
			/*MAIN:*/{
				$(document).ready(function(){
					avvio_rapido ? avvia_gioco() : carica_div_preload();
				});
			}
			  
			/*Funzioni:*/{
				function carica_div_preload(){
					presentazione_gioco();
				}
				
				/*Presentazioni*/{
					function presentazione_gioco(){//presentazione gioco
						//log:
						var_log += (((new Date()).toTimeString()).split(' ')[0]) + " : <b style='color: green;'> Presentazione Gioco</b><br />";
					  
						//bottoni:
						var bottone_avvia_gioco = '<a class="btn btn-default" href="#" role="button" onclick="avvia_gioco()">Avvia il gioco</a>';
						var bottone_pres_regole = '<a class="btn btn-default" href="#" role="button" onclick="presentazione_regole()">Presentazione delle regole</a>';
						
						//carica contenitore:
						$('#contenitore_campo_console').html('<div id="div_pres_gioco" style="background-color: blue; height: 500px; width: 100%; display: none;" class="center"><b><u><h1 class="center marginpadding">Presentazione del gioco</h1></u></b><p><p></p><p style="padding: 10;">Questo gioco nasce con la finalità di ...<p><p>'+bottone_avvia_gioco+'   '+bottone_pres_regole+'</p></div>');
						$('#div_pres_gioco').fadeIn(3500);
					}
					  
					function presentazione_regole(){//presentazione regole
						//log:
						var_log += (((new Date()).toTimeString()).split(' ')[0]) + " : <b style='color: green;'> Presentazione Regole</b><br />";
					  
						//bottoni:
						var bottone_avvia_gioco = '<a class="btn btn-default" href="#" role="button" onclick="avvia_gioco()">Avvia il gioco</a>';
						
						//carica contenitore
						$('#contenitore_campo_console').html('<div id="div_pres_regole" style="background-color: red; height: 500px; width: 100%; display: none;" class="center"><h1 class="center marginpadding">descrizione regole gioco</h1><p style="padding: 10;">Testo delle regole<p><p>'+bottone_avvia_gioco+'</p></div>');
						$('#div_pres_regole').fadeIn(3500);
					}

					function presentazione_obbiettivo_raggiunto(pos_obb){//presentazione obbiettivo
						//bottoni:
						var bottone_chiudi = '<a class="btn btn-default" href="#" role="button" onclick="ricarica_partita()">Chiudi</a>';
						
						//visualizza testo
						$('#contenitore_campo_console').html('<div id="div_obbiettivi" style="background-color: yellow; height: 500px; width: 100%; display: none;" class="center"><h1 class="center marginpadding">descrizione obbiettivo</h1><p style="padding: 10;">Testo obb<p><p>'+bottone_chiudi+'</p></div>');
						$('#div_obbiettivi').fadeIn(3500);
					}
					
					function presentazione_gioco_completato(){//presentazione fine gioco
						/*log:*/{
							//creo testo per log
							var temp_log = (((new Date()).toTimeString()).split(' ')[0]) + " : <b style='color: green;'> Gioco completato </b><br />";
							//agg. variabile
							var_log += temp_log;
							//agg. div
							$("#log_eventi").append(temp_log);
						}
						
						//bottoni:
						var bottone_gioco = '<a class="btn btn-default" href="index.html" role="button" onclick="index.html">Riavia gioco</a>';
						
						//carica contenitore
						$('#contenitore_campo_console').html('<div id="div_gioco_completato" style="background-color: green; height: 500px; width: 100%; display: none;" class="center"><h1 class="center marginpadding">descrizione gioco concluso</h1><p style="padding: 10;">congratulazioni...<p>'+bottone_gioco+'</div>');
						$('#div_gioco_completato').fadeIn(3500);
					}
				}
				
				function avvia_gioco(){//avvia gioco
					//crea il campo
					$('#campo_totale').html(codice_campo_console);
					posizioni=[];
					crea_griglia();
					
					/*log:*/{
						//agg var. log
						var_log += (((new Date()).toTimeString()).split(' ')[0]) 
										+ " : <b style='color: green;'>"
										+ "  Avvio Gioco"
										+ "</b><br />"
									;
						
						//scrive il log
						$("#log_eventi").append(""+ var_log);
					}
					
					//carica la mappa
					carica_livello(livello, mappa);		
				}
				
				function crea_griglia(){//crea la griglia del campo				
					/*ricarica struttura*/{
						$('#campo_totale').html(codice_campo_console);
					}
				
					/*crea griglia*/{
						//imposto che la griglia si veda solo se primo livello o impostato in debug
						var spes_griglia_campo = ((mappa == 1) || (var_vis_griglia)) ? colore_griglia_se_visualizzata /*visualizza*/ : background_color_campo /*nascondi*/;
						
						//stile della tabella
						var table_style =   'class="main-story-image" '
										  + 'style='
											+ '"background-color:' + background_color_campo + '; '
											+ 'line-height: 19px; '
											+ 'margin: 4px 4px 4px 4px;'
											+ '" '
										  + 'border="1px"'
										  + 'bordercolor="'+spes_griglia_campo + '"'
										;
					
						//inserisce tag inizio tabella
						var content = '<div class="table-responsive"><table id="tabella_campo" ' + table_style + '>';
						
						//inserisce le varie celle
						for (var i = 0; i < num_righe; i++) {
							content += "<tr></tr>";
							for (var j = 0; j < num_colonne; j++) {			  
								content += "<td id='" + i + sep_rig_col + j + "'><b style='color: " + colore_testo_campo + ";'>" + (vuota_attrav_img? pos_vuota_img : pos_vuota) + "</b></td>";
							}
						}
						
						//inserisce tag fine tabella
						content += "</table></div>";
					}
					
					/*visulizza griglia*/{
						$('.campo').append(content);
					}
				}

				function random_posizione(){//genera random una posizione
					return (   (Math.floor(Math.random() * num_righe) + 0)   //riga 
							 + sep_rig_col 
							 + (Math.floor(Math.random() * num_colonne) + 0) //colonna
							);
				}
				  
				function posizione_sprite_array(ogg_sprite){//ritorna la posizione nell'array dello sprite indicato
					//memorizza l'indice della posizione del personaggio/indice ricorsione
					var loc_arr_pos = 0;
					
					while ((posizioni[loc_arr_pos].oggetto) != ogg_sprite){//trova la posizione del personaggio nell'array
						/*Debug*/{
							if (var_debug_pos_sprite_array || var_debug_all)
								alert("Posizione: " + loc_arr_pos + " Valore: " + posizioni[loc_arr_pos].oggetto);
						}
						
						//aggiorna indice
						loc_arr_pos += 1;
					}
					
					return loc_arr_pos;
				}
				  
				function spostamento_personaggio(azione, spostamento, simula){//simula o effettua lo spostamento del msg	    		
					/*posizione personaggio*/{
						//nell'array
						var loc_arr_pos = posizione_sprite_array("Personaggio");
						
						//var temp:
						var pos_teorica_pers_riga    = posizioni[loc_arr_pos].riga;
						var pos_teorica_pers_colonna = posizioni[loc_arr_pos].colonna;
					}
					
					/*Debug*/{
						if(var_debug_spost_personaggio || var_debug_all){
							alert("Sim spost Personaggio - situazione iniziale \n"
								  + azione +", "+ spostamento +", "+ simula + "\n"
								  + "pers.riga: "    + posizioni[loc_arr_pos].riga + " | " + pos_teorica_pers_riga + "\n"
								  + "pers.colonna: " + posizioni[loc_arr_pos].colonna + " | " + pos_teorica_pers_colonna
								);
						}
					}
					
					/*calcola nuova posizione*/{
						switch(azione){//calcola le nuove coordinate
							case "Nord"       :
							case "Su"         :
							case "Sopra"      :					   
											   pos_teorica_pers_riga -= spostamento; 
								break;
							case "Sud"        :
							case "Giu"        :
							case "Sotto"      :					   
											   pos_teorica_pers_riga += spostamento; 
								break;
							case "Est"        :
							case "Destra"     :
											   pos_teorica_pers_colonna += spostamento; 
								break;
							case "Ovest"      :
							case "Sinistra"   :						   
											   pos_teorica_pers_colonna -= spostamento; 
								break;
							case "Nord-Ovest" :
											   pos_teorica_pers_riga -= spostamento;
											   pos_teorica_pers_colonna -= spostamento;
								break;
							case "Sud-Ovest"  : 
											   pos_teorica_pers_riga += spostamento;
											   pos_teorica_pers_colonna -= spostamento;
								break;
							case "Nord-Est"   :
											   pos_teorica_pers_riga -= spostamento;
											   pos_teorica_pers_colonna += spostamento;
								break;
							case "Sud-Est"    : 
											   pos_teorica_pers_riga += spostamento;
											   pos_teorica_pers_colonna += spostamento;
								break;
						}
					}
					
					/*Agg. posizione personaggio se non simulato*/{
						if (simula != "si"){
							posizioni[loc_arr_pos].riga = pos_teorica_pers_riga;
							posizioni[loc_arr_pos].colonna = pos_teorica_pers_colonna;
							posizioni[loc_arr_pos].coordinate = pos_teorica_pers_riga + sep_rig_col + pos_teorica_pers_colonna;
						}
					}
					
					/*Debug*/{
						if(var_debug_spost_personaggio || var_debug_all){
							alert("Sim spost Personaggio - situazione finale" + "\n"
								  + "pos: " + posizioni[loc_arr_pos].coordinate + "|" + pos_teorica_pers_riga + sep_rig_col + pos_teorica_pers_colonna + "\n"
								  + "riga: " + posizioni[loc_arr_pos].riga + " | " + pos_teorica_pers_riga + "\n"
								  + "colonna: " + posizioni[loc_arr_pos].colonna + " | " + pos_teorica_pers_colonna + "\n"
								);
						}
					}
					
					return (pos_teorica_pers_riga + sep_rig_col + pos_teorica_pers_colonna);
				  }
				 
				function posizione_vuota(){//ritorna la prima posizione vuota trovata con random
					//memorizza possibili posizioni
					var temp_pos_input = "";
					
					//verifica se posizione utilizzata
					while (posizione_utilizzata(temp_pos_input = random_posizione()));//cicla finche non trova una posizione valida
					
					return temp_pos_input;
				}
				 
				function carica_sprite(var_oggetto, var_number, var_completato, sprite, temp_posizione){//carica l'oggetto
					//carica sprite nella griglia
					$("#"+temp_posizione).html(sprite);
					
					/*carica sprite nell'array:*/{
						//posizione vuota array:
						var temp_pos_vettore = posizioni.length;
						
						//coordinate sprite:
						var temp_riga = parseInt(temp_posizione.substring(0, temp_posizione.indexOf(sep_rig_col)));
						var temp_colonna = parseInt(temp_posizione.substring(temp_posizione.indexOf(sep_rig_col) + 1));
						
						//aggiungo elemento all'array
						posizioni[temp_pos_vettore]= {coordinate:temp_posizione, oggetto: var_oggetto, number: var_number, completato: var_completato, riga: temp_riga, colonna: temp_colonna};
					}
							
					/*Debug*/{
						if(var_debug_carica_sprite || var_debug_all){
							alert("Array agg:" + "\n"
								  + "coordinate: " + posizioni[temp_pos_vettore].coordinate + ", "
								  + "oggetto: " +  posizioni[temp_pos_vettore].oggetto + ", "
								  + "number: " +  posizioni[temp_pos_vettore].number + ", "
								  + "completato: " +  posizioni[temp_pos_vettore].completato + ", "
								  + "riga: " +  posizioni[temp_pos_vettore].riga + ", "
								  + "colonna: " +  posizioni[temp_pos_vettore].colonna + ", "
							);
						}
					}
					
					return temp_posizione;
				  }
		 
				function verifica_comando(comando, azione, passi, errore_nel_comando){//verifica validità comando
					
					var err_sintassi = (    errore_nel_comando 
					                     || sintassi_comando_errata(comando, azione, passi) 
									   );
					var err_spostamento = (    spostamento_comando_non_valido(comando, azione, passi) 
					                        || ostacoli_nel_tragitto(comando, azione, passi)
										  );
					
					
					return {err_com:( err_sintassi || err_spostamento ),
							err_sint: err_sintassi,
							err_spost: err_spostamento							
						   };    
				}
					  
				function spostamento_comando_non_valido(comando, azione, passi){//spostamento valido
					
					//se numero pazzi validi
					if (passi > 0) { 
						//calcola spostamento - simulazione
						var sim_agg_pos = spostamento_personaggio(azione, passi, 'si');
						
						//riga
						var sim_riga_pers = sim_agg_pos.substring(0,sim_agg_pos.indexOf(sep_rig_col));
						
						//colonna
						var sim_colonna_pers = sim_agg_pos.substring(sim_agg_pos.indexOf(sep_rig_col)+1);
					}
					
					/*Debug*/{
						if(var_debug_spost_comando_non_valido || var_debug_all){
							alert( "comando: "+comando+", azione: "+ azione +", passi: " + passi + "\n"
								   + "val pasi " + ((passi < 1) || (passi == null) || (passi == undefined) || (passi == "") || (isNaN(passi))) + "\n"
								   + "Sim riga "+ ( sim_riga_pers < 0 || sim_riga_pers > (num_righe -1) ) + "\n"
								   + "Sim colonna "+ ( sim_colonna_pers < 0 || sim_colonna_pers > (num_colonne -1)) +"\n"
								 );
						}
					}
					
					return (     //valore negativo
								 ((passi < 1) || (passi == null) || (passi == undefined) || (passi == "") || (isNaN(passi)))
							  || //riga
								 ( sim_riga_pers < 0 || sim_riga_pers > (num_righe -1) )
								 //colonna
							  || ( sim_colonna_pers < 0 || sim_colonna_pers > (num_colonne -1) )
							);
				  }
				
				function restituisce_time(){//restituisce orario
					//per log indica orario comando:
					var data_ora = new Date();
					var date_ora_text = (data_ora.toTimeString()).split(' ')[0];
					
					//tempo trascorso:
					var tempo_elapsed_text = "";//" [" + (data_avvio_gioco - data_ora) +"]";
					
					return {ora_txt: date_ora_text, time_elapsed: tempo_elapsed_text};
				}
				
				function posizione_utilizzata(test_posizione){//verifica se la posizione indicata contiene uno sprite
					//variabile controllo ciclo risultato
					posizione_occupata = false;	
					
					/*verifica se la coordinata è presente nell'array*/{
						for (var i = 0; i < posizioni.length; i++){
							if (posizioni[i].coordinate == test_posizione) {
								posizione_occupata = true;
							}
							
							/*Debug*/{
								if(var_debug_pos_utilizzata || var_debug_all){
									alert("Ver posizione (" + i + ")\n"
										  + "utilizzata: " + posizioni[i].coordinate 
										  + " | " 
										  + "proposta:   " + test_posizione
										 );
								}
							}
						}
					}
					
					return posizione_occupata;
				}
				
				function ostacoli_nel_tragitto(comando, azione, passi){//verifica presenza ostacoli lungo il tragitto
					//variabile controllo ciclo risultato
					var ostacolo_presente = false;
					
					/*verifica tutte le posizioni del tragitto*/{
						for (var step_ver_perc_ost = 0; step_ver_perc_ost < passi; step_ver_perc_ost++){
							
							//verifica se nella posizione "n" è presente un'ostacolo
							if (raggiunto_sprite(spostamento_personaggio(azione, step_ver_perc_ost+1, "si"), 'Ostacolo').bool) {
								ostacolo_presente = true;
							}
							
							/*Debug*/{
								if(var_debug_ostacoli_tragitto || var_debug_all){
									alert(   "comando: "+comando + ", azione: " + azione + ", passi: " + passi +"\n"
										   + "sim - posizione attuale " + step_ver_perc_ost + "\n"
										   + "sim - nuova posizione   " + spostamento_personaggio(azione, step_ver_perc_ost+1, "si") + "\n"
										   + "ostacolo percorso       " + (raggiunto_sprite(spostamento_personaggio(azione, step_ver_perc_ost+1, "si"), 'Ostacolo').bool)   
										  )
								}
							}
						}
					}
					
					return ostacolo_presente;
				}
				
				function raggiunto_sprite(test_posizione, tipo_sprite_ragg){//verifica se la posizione indicata contiene un determinato sprite
					//controllo ciclo - risultato
					var sprite_presente = {bool:false, posizione: -1};	
					
					/*verifica se la posizione è nell'array delle posizioni:*/{
						for (var i = 0; i < posizioni.length; i++){
							if ((posizioni[i].coordinate == test_posizione) && (posizioni[i].oggetto == tipo_sprite_ragg )) {//controlla la posizoine i dell'array
								sprite_presente = {bool:true, posizione: i};
							}
							
							/*Debug*/{
								if(var_debug_ragg_sprite || var_debug_all){//Debug
									alert(  "Verifica se presente spryte di tipo: "+tipo_sprite_ragg+":" + "\n"
										  + "Esito controllo If: "((posizioni[i].coordinate == test_posizione) && (posizioni[i].oggetto == tipo_sprite_ragg )) +"\n"
										  + "Verifica pos array("+i+"): " + posizioni[i].coordinate  
										  + " | "  + "tipo: " + posizioni[i].oggetto + "\n"
										  + "posizione cercata:   " + test_posizione
										 );
								}
							}
						}
					}
					
					return sprite_presente;
				}
		
				function pulisci_campo(){//pulisce il campo per caricare il nuovo livello
					/*pulisci griglia*/{
						for (var i = 0; i < num_righe; i++) {
							for (var j = 0; j < num_colonne; j++) {			  
								$("#"+(i + sep_rig_col + j)).html("<b style='color: " + colore_testo_campo + ";'>" + (vuota_attrav_img? pos_vuota_img : pos_vuota) + "</b>");
							}
						}
					}
					
					/*pulisci array posizioni*/{
						posizioni=[];
					}
				}
				
				function ricarica_partita(){//ripristina partita sospesa
					/*Griglia*/{
						crea_griglia();	
					}
					 
					/*ricarica oggetti da array nella griglia*/{
						for (var k = 0; k < posizioni.length; k++){
							switch(posizioni[k].oggetto){//in base all'oggetto lo ricarica nella sua posizione
								case "Personaggio" : $("#"+posizioni[k].coordinate).html(personaggio_img);
									break;
								case "Exit"        : $("#"+posizioni[k].coordinate).html(exit_img);
									break;
								case "Ostacolo"    : $("#"+posizioni[k].coordinate).html(ostacolo_img);
									break;
								case "Obbiettivo"  : if (posizioni[k].completato == false) $("#"+posizioni[k].coordinate).html(obbiettivo_img);
									break;
								case "Percorso"    : $("#"+posizioni[k].coordinate).html((vuota_attrav_img ? pos_attraversata_img : pos_attraversata));
									break;
							}
						}
					}
					/*aggiorna log*/{
						ricarica_log();
					}
				}
				
				function ricarica_log(){//ricarica i log
					/*aggiorna log*/{
						$("#log_eventi").append(""+ var_log);
					}
				}
				
				function sintassi_comando_errata(comando, azione, passi){//sintassi comando valida
					return (//comando validi:
								(azione != "Nord")        && (azione != "Su")        && (azione != "Sopra")
							 && (azione != "Nord-Est") 
							 && (azione != "Nord-Ovest") 
							 
							 && (azione != "Sud")         && (azione != "Giu")       && (azione != "Sotto")
							 && (azione != "Sud-Est") 
							 && (azione != "Sud-Ovest")
							 
							 && (azione != "Est")         && (azione != "Destra")   
							 && (azione != "Ovest")       && (azione != "Sinistra")
						   );
				}
				  
				function completato_livello(){//verifica se è stato completato il livello
					if(    ((num_obbiettivi != 0) && (var_obb_superflui == false))
						&& (posizioni[posizione_sprite_array("Personaggio")].coordinate == posizioni[posizione_sprite_array("Exit")].coordinate))
						 alert("Devi prima raggiungere tutti gli obbiettivi, il personaggio è uscito dalla porta ma è in attesa di rientrare.\nDigita un comando.");
					
					return (    ((num_obbiettivi == 0) || (var_obb_superflui))
							 && (posizioni[posizione_sprite_array("Personaggio")].coordinate == posizioni[posizione_sprite_array("Exit")].coordinate)
							);
				}
				
				function livello_successivo(){//prossimo livello
					/*Debug*/{
						if(var_debug_liv_successivo || var_debug_all){
							alert("liv attuale: "+livello+", mappa: "+mappa);
						}
					}
					
					return ((mappa == liv_map[livello-1].mp) ? {liv: (livello == (liv_map.length)? -1 : livello+1), map: 1,       fin: (livello == (liv_map.length)? true : false)} 
															 : {liv: livello ,                                      map: mappa+1, fin: false});
				}

				function obbiettivo_raggiunto(posizione_pot_obb){//verifica se è stato raggiunto un obbiettivo
					//c'è un obbiettivo nella posizione
					var obb_pres = raggiunto_sprite(posizione_pot_obb, 'Obbiettivo');
					
					//risultato
					var obb_ragg = false;
					
					/*Debug*/{
						if(var_debug_obb_raggiunto || var_debug_all){
						   alert("controllo: "+(obb_pres.bool && (posizioni[obb_pres.posizione].completato == false)));
						}
					}
					
					/*verifica se obbiettivo presente e completato*/{
						if (obb_pres.bool && (posizioni[obb_pres.posizione].completato == false)){
							//ritorna che l'obbiettivo è stato raggiunto
							obb_ragg = true;
							//aggiorna obbiettivo
							posizioni[obb_pres.posizione].completato = true;
							//agg. numero obbiettivi
							--num_obbiettivi;
						  
							//visualizzo descrizione obbiettivo						
							presentazione_obbiettivo_raggiunto(obb_pres.posizione);
							
							/*log:*/{
								var temp_or = restituisce_time();
								
								var temp_log =   ""
									   + temp_or.ora_txt 
									   + temp_or.time_elapsed
									   + " : <b style='color: yellow;'>"
									   +" [" + posizione_pot_obb + "] : "
									   + "Obbiettivo completato"
									   +"</b><br />";
								
								//aggiorna log:
								var_log += temp_log;
								$("#log_eventi").append(temp_log);
							}

						}
					}
					
					return obb_ragg;
				}

				function recupera_comando(){//recupera il comando inserito dal giocatore
					/*Recupera comando*/{
						//{com: comando, az: azione, ps: passi}
						var comando = {com: $("#comando").val(),az: null, sp: null, err: null};
						//rimuove gli spazi dal comando
						if (rimuovi_spazi_comando) {comando.com = (comando.com).replace(/ /g, '');}
						//formatta secondo lo standard del comando
						if (!comand_case_sensitive) {
							var tem_string = ((comando.com).toLowerCase());
							comando.com = (tem_string = tem_string.charAt(0).toUpperCase() + tem_string.slice(1));
							
							if(tem_string.indexOf("-") != -1){//comandi composti da più parole?
								comando.com =   tem_string.substring(0,tem_string.indexOf("-"))
											  + "-" 
											  + (tem_string.substring(tem_string.indexOf("-")+1)).charAt(0).toUpperCase() 
											  + (tem_string.substring(tem_string.indexOf("-")+1)).slice(1);
							}
						}
					}
					
					/*Scompone comando*/{
						if (comando != ""){
							comando.az = (comando.com).substring(0,(comando.com).indexOf("("));
							comando.sp = parseInt((comando.com).substring((comando.com).indexOf("(")+1,(comando.com).indexOf(")")));
							comando.err = (((comando.com).substring((comando.com).indexOf(")")+1)).length != 0);
						}
					}
					
					/*Debug*/{
						if(var_debug_recupera_comando || var_debug_all){
							alert(   "comando: " + comando.com + "\n"
								   + "azione: " + comando.az + "\n"
								   + "spostamento: " + comando.sp + "\n"
								   + "errore: " + comando.err +" \n"
								 );
						}
					}
					
					return comando;
				}
				
				function esegui_comando(){//esegue lo spostamento
					//recupera comando
					var comando = recupera_comando();
					
					/*presente un comando*/{
						if (comando.com != "")//comando inserito?
								 {//Si
									/*var per log:*/{
										//orario lancio comando
										var data_inizio = restituisce_time();
										
										//var temp log
										var temp_log ="";
									}
								
									/*comando valido + esecuzione*/{
									    var ver_comando = null;
										if ((ver_comando=verifica_comando(comando.com, comando.az, comando.sp, comando.err)).err_com) 
												 {//comando errato
												  //tipo errore:
												  var tp_err = (ver_comando.err_sint && ver_comando.err_spost)? 
												                      "Comando errato"
												                    : (ver_comando.err_sint? 
																	          "Sintassi comando errata" 
																			: "Spostamento richiesto con il comando non valido")
												  /*temp log:*/{
													temp_log =   ""
															   + data_inizio.ora_txt 
															   + data_inizio.time_elapsed
															   + " : <b style='color: red;'>"
															   + "<u>"   
															   + comando.com
															   + " <BIG>*</BIG>"
															   + "</u> "
															   + "</b><br />";
												  } 
												  
												  alert("ERRORE: "+tp_err+".");
												 } 
											else {//comando valido
													/*Recupera posizione personaggio*/{
														var loc_arr_pos = posizione_sprite_array("Personaggio");
													}
											
													/*Esegue spostamento*/{
														for (var shift = 0; shift < comando.sp; shift++) {
															/*Agg. posizione personaggio*/{
																//nasconde personaggio
																$("#personaggio").fadeOut(1500);
																//evidenzia percorso
																if ((raggiunto_sprite(posizioni[loc_arr_pos].coordinate, 'Exit').bool) == false){
																		carica_sprite("Percorso", 0, false, (vuota_attrav_img ? pos_attraversata_img : pos_attraversata), posizioni[loc_arr_pos].coordinate);
																	}
																//aggiorna riferimenti personaggio
																spostamento_personaggio(comando.az, 1, 'no');
																//rivisualizza il personaggio
																if ((raggiunto_sprite(posizioni[loc_arr_pos].coordinate, 'Exit').bool) == false){
																		$("#"+posizioni[loc_arr_pos].coordinate).html(personaggio_img).fadeIn(1000);
																	}
															}
															
															/*raggiunto obbiettivo*/{
																obbiettivo_raggiunto(posizioni[loc_arr_pos].coordinate);
															}
														}
													}
											
													/*agg log in var temp:*/{
														temp_log =   ""
																   + data_inizio.ora_txt 
																   + data_inizio.time_elapsed
																   + " : <b style='color: blue;'>"
																   + " [" + (posizioni[loc_arr_pos].coordinate) + "] : "
																   + comando.com
																   + "</b><br />";
													}
											
													/*livello completato*/{							
														if(completato_livello()){//completato livello
															/*agg log in var temp:*/{
																var temp_or = restituisce_time();
																
																temp_log +=  ""
																		   + temp_or.ora_txt 
																		   + temp_or.time_elapsed
																		   + " : <b style='color: yellow;'>"
																		   +" [" + (posizioni[loc_arr_pos].coordinate) + "] : "
																		   + "Livello completato"
																		   +"</b><br />";
															}
															
															var liv_comp = true;
														
														}
													}
												 }
									}
									
									/*agg log*/{
										var_log += temp_log;
										$("#log_eventi").append(temp_log);
									}
									
									/*carica livello successivo*/{
										if(liv_comp == true) carica_livello();
									}							
								 }
							else {//No
								  alert("Inserire un comando nell'input box");
								 }
					}
				}
					  
				function carica_livello(num_livello, num_mappa){//carica il livello
					/*livello da caricare*/{
						/*variabile in cui memorizza il prossimo livello*/{
							var liv_succ = "";
							
							if(      ((num_livello == null) || (num_livello == undefined)) 
								  && ((num_mappa == null)   || (num_mappa == undefined))
							   )
									 {//informazioni non passate
										liv_succ = livello_successivo();
									 }
								else {//informazioni passate
										liv_succ = {liv: num_livello, map: num_mappa, fin: (livello == -1? true : false)};
									 }
						}
						
						/*agg. variabili livello*/{
							livello = liv_succ.liv;
							mappa = liv_succ.map;
						}	

						/*Debug*/{
							if(var_debug_carica_livello || var_debug_all){
								alert(   "num_livello: " + num_livello + ", num_mappa: "+num_mappa+"\n"
									   + "(num_livello = null): " + (num_livello == null) +  ", (num_livello = undefined): " + (num_livello == undefined) + "\n"
									   + "(num_mappa = null): " + (num_mappa == null) + ", (num_mappa = undefined): " + (num_mappa == undefined) + "\n"
									   + "liv succ: "+livello+" | "+liv_succ.liv+", mappa: "+mappa+" | "+liv_succ.map + "\n"
									   + "Gioco completato? "+ liv_succ.fin
									 );
							}
						}	
					}
							
					/*carica livello*/{
						if (liv_succ.fin == false) 
							   {//gioco non concluso
								/*pulisci campo*/{
									if (mappa > 2) //primi due livelli? 
											 {//si 
											  pulisci_campo();
											 }
										else {//no
											  //pulisce array posizioni
											  posizioni=[];
											  //ricarica griglia
											  crea_griglia();
											  //ricarica log
											  ricarica_log();
											 }
								}		 
							
								/*Carica oggetti*/{
									if (livello > (liv_min_ostacoli-1)) {/*Ostacoli*/
										var num_ost = (10 + livello ) * mappa;
										for (var num_ost_car=0; num_ost_car<((10+livello)*mappa); num_ost_car++){//Random ostacoli
											carica_sprite("Ostacolo", num_ost_car, false, ostacolo_img, posizione_vuota());    
										}	
									
										/*Debug*/{
											if(var_debug_carica_livello || var_debug_all){
												alert(   "Liv. "+livello+", Map. "+mappa+"\n"
													   + "caricati "+num_ost+" ostacoli."
													 );
											}
										}
									}
									
									if (livello > (liv_min_obbiettivi-1)){/*Obbiettivi*/
										for (var num_obb_car=0; num_obb_car < (Math.floor(Math.random() * 5) + 6) ; num_obb_car++){//Random obbiettivi
											carica_sprite("Obbiettivo", num_obb_car, false, obbiettivo_img, posizione_vuota());
											
											//agg. numero obbiettivi
											++num_obbiettivi;
										}
										
										/*Debug*/{
											if(var_debug_carica_livello || var_debug_all){
												alert(   "Liv. "+livello+", Map. "+mappa+"\n"
													   + "caricati "+num_obbiettivi+" obbiettivi."
													 );
											}
										}
									}
									
									/*personaggio*/{
										carica_sprite("Personaggio", 0, false, personaggio_img, posizione_vuota());
									}
									
									/*exit*/{
										carica_sprite("Exit", 0, false, exit_img, posizione_vuota());
									}
								}
							
								/*verifico posizioni Personaggio e Exit nell'array*/{
									var temp_pos_pers = posizione_sprite_array("Personaggio");
									var temp_pos_exit = posizione_sprite_array("Exit");
								}
							
								/*log:*/{
									var temp_or = restituisce_time();
											
									var temp_log = ""
										+ temp_or.ora_txt 
										+ temp_or.time_elapsed
										+ " : <b style='color: orange;'>"
										+ "Caricato Liv."+livello+" Mappa "+mappa
										+ "</b><br />                 { " 
										+ "Personaggio [" + (posizioni[temp_pos_pers].coordinate) + "] - "
										+ "Exit [" + (posizioni[temp_pos_exit].coordinate) + "]"
										+" }"
										+"<br />"
										;

									/*aggiorna log:*/{
										//variabile
										var_log += temp_log;
										//campo a video
										$("#log_eventi").append(temp_log);
									}
								}
							
								/*Debug*/{
									if(var_debug_carica_livello || var_debug_all){
										alert("Personaggio " + "\n"
											  + "pos: " + posizioni[temp_pos_pers].coordinate + "\n"
											  + "riga: " + posizioni[temp_pos_pers].riga + "\n"
											  + "colonna: " + posizioni[temp_pos_pers].colonna + "\n"
											  
											  +"\nExit " + "\n"
											  + "pos: " + posizioni[temp_pos_exit].coordinate + "\n"
											  + "riga: " + posizioni[temp_pos_exit].riga + "\n"
											  + "colonna: " + posizioni[temp_pos_exit].colonna + "\n"
											 );
									}
								}
							
							   }
						  else {//gioco finito
								/*Debug*/{
									if(var_debug_carica_livello || var_debug_all){
									   alert("Fine gioco");
									}
								}
							 
								presentazione_gioco_completato();
							   }
					}
				}  

			}
			  
			/*Da implementare:*/{ 
				/*non togliere gli obbiettivi se non visualizzati*/
			} 
		</script>
    </body>
</html>